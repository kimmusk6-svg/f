import os
import telebot
import requests

# è‡ªåŠ¨è¯»å– Railway ä¸­çš„å˜é‡
TOKEN = os.getenv('BOT_TOKEN')
DS_KEY = os.getenv('DEEPSEEK_API_KEY')

bot = telebot.TeleBot(TOKEN)

def get_ai_reply(text):
    url = "https://api.deepseek.com/chat/completions"
    # æ³¨æ„ï¼šBearer åé¢çš„ç©ºæ ¼è‡³å…³é‡è¦
    headers = {
        "Authorization": f"Bearer {DS_KEY}", 
        "Content-Type": "application/json"
    }
    data = {
        "model": "deepseek-chat",
        "messages": [
            {"role": "system", "content": "ä½ æ˜¯ä¸€åªå¹½é»˜çš„é¾™è™¾AIç®¡å®¶ğŸ¦ã€‚"},
            {"role": "user", "content": text}
        ],
        "stream": False
    }
    
    response = requests.post(url, json=data, headers=headers, timeout=20)
    
    # è¯Šæ–­é€»è¾‘ï¼šå¦‚æœä¸æ˜¯200ï¼Œè¯´æ˜Keyæˆ–ä½™é¢æœ‰é—®é¢˜
    if response.status_code != 200:
        return f"ğŸ¦ å¤§è¯å‡ºçŠ¶å†µäº†ï¼šé”™è¯¯ç  {response.status_code} (è¯·ç¡®è®¤DeepSeekä½™é¢æˆ–Keyæ˜¯å¦æ­£ç¡®)"
        
    return response.json()['choices'][0]['message']['content']

@bot.message_handler(func=lambda message: True)
def chat(message):
    try:
        bot.send_chat_action(message.chat.id, 'typing')
        reply = get_ai_reply(message.text)
        bot.reply_to(message, reply)
    except Exception as e:
        bot.reply_to(message, f"ğŸ¦ å“å‘€ï¼Œå‰¥è™¾å£³æ‰‹æ»‘äº†ï¼š{str(e)}")

print("DeepSeek Lobster Online!")
bot.infinity_polling()
